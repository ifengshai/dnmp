<?php
/**
 * Wangwei.php
 * @author huangbinbin
 * @date   2021/6/25 14:56
 */

namespace app\admin\controller;


use app\admin\model\itemmanage\Item;
use app\admin\model\itemmanage\ItemPlatformSku;
use app\admin\model\order\order\NewOrderItemOption;
use app\admin\model\order\order\NewOrderItemProcess;
use app\admin\model\saleaftermanage\WorkOrderChangeSku;
use app\admin\model\saleaftermanage\WorkOrderList;
use app\admin\model\saleaftermanage\WorkOrderMeasure;
use app\admin\model\StockLog;
use app\admin\model\warehouse\StockSku;
use app\common\controller\Backend;
use think\Controller;
use think\db\exception\DataNotFoundException;
use think\db\exception\ModelNotFoundException;
use think\Exception;
use think\exception\DbException;
use think\exception\PDOException;
use think\exception\ValidateException;
use think\Log;
use think\Model;
use think\Request;

/**
 * 王伟批量创建补发订单的功能
 *
 * Class Wangwei
 * @package app\admin\controller
 * @author  huangbinbin
 * @date    2021/6/25 14:56
 */
class Wangwei extends Backend
{
    protected $noNeedLogin = ['*'];
    protected $order = null;
    protected $orderItem = null;

    public function __construct(Request $request = null)
    {
        parent::__construct($request);
        $this->order = new \app\admin\model\order\order\NewOrder();
        $this->orderItem = new NewOrderItemOption();
        $this->work = new WorkOrderList();
    }

    public function test()
    {
        $siteType = input('sitetype');
        $workId = input('workid');
        $incrementId = input('incrementid');
        $measureId = input('measureid');
        $this->createOrder($siteType, $workId, $incrementId, $measureId);
    }

    /**
     * 创建补发单
     *
     * @param $siteType
     * @param $work_id
     *
     * @throws DataNotFoundException
     * @throws ModelNotFoundException
     * @throws DbException
     */
    public function createOrder($siteType, $workId, $incrementId, $measureId)
    {
        echo 'createOrder' . PHP_EOL;
        $orderDetail = $this->getOrderDetail($siteType, $incrementId);

        //如果存在补发单的措施
        if ($orderDetail) {
            echo "补发单创建请求" . PHP_EOL;
            echo serialize($orderDetail) . PHP_EOL;
            echo "补发单创建请求two" . PHP_EOL;
            if (!empty($orderDetail)) {
                try {
                    //补发扣库存
                    $pathinfo = 'magic/order/createOrder';
                    $res = $this->work->httpRequest($siteType, $pathinfo, $orderDetail, 'POST');

                    $replacementOrder = $res['increment_id'] ?? '';
                    if (!$replacementOrder) {
                        file_put_contents('./wangwei_error.log', $incrementId . PHP_EOL, FILE_APPEND);
                        echo '请求补发失败' . PHP_EOL;

                        return false;
                    }

                    $workOrderChangeSkusAll = [];
                    foreach ($orderDetail['product'] as $key => $val) {
                        $workOrderChangeSkusAll[$key] = [
                            'work_id'             => $workId,
                            'increment_id'        => $incrementId,
                            'platform_type'       => $siteType,
                            'original_name'       => $val['sku'],
                            'original_sku'        => $val['sku'],
                            'original_number'     => $val['qty'],
                            'change_type'         => 5,
                            'change_sku'          => $val['sku'],
                            'change_number'       => $val['qty'],
                            'recipe_type'         => $val['prescription_type'],
                            'lens_type'           => $val['lens_type'],
                            'od_sph'              => $val['od_sph'],
                            'od_cyl'              => $val['od_cyl'],
                            'od_axis'             => $val['od_axis'],
                            'od_add'              => $val['od_add'],
                            'pd_r'                => $val['pd_r'],
                            'od_pv'               => $val['od_pv'],
                            'od_bd'               => $val['od_bd'],
                            'od_pv_r'             => $val['od_pv_r'],
                            'od_bd_r'             => $val['od_bd_r'],
                            'os_sph'              => $val['os_sph'],
                            'os_cyl'              => $val['os_cyl'],
                            'os_axis'             => $val['os_axis'],
                            'os_add'              => $val['os_add'],
                            'pd_l'                => $val['pd_l'],
                            'os_pv'               => $val['os_pv'],
                            'os_bd'               => $val['os_bd'],
                            'os_pv_r'             => $val['os_pv_r'],
                            'os_bd_r'             => $val['os_bd_r'],
                            'create_person'       => '王伟',
                            'update_time'         => date('Y-m-d H:i:s'),
                            'create_time'         => date('Y-m-d H:i:s'),
                            'measure_id'          => $measureId,
                            'replacement_order'   => $replacementOrder,
                            'email'               => $orderDetail['email'],
                            'userinfo_option'     => serialize($orderDetail),
                            'prescription_option' => serialize($val),
                        ];
                    }

                    //添加workorderchangesku的数据
                    WorkOrderChangeSku::insertAll($workOrderChangeSkusAll);
                    //回写主表
                    WorkOrderList::where('id', $workId)->setField('replacement_order', $replacementOrder);

                    $this->work->deductionStock($workId, $measureId);
                    echo "补发单SUCCESS - " . $replacementOrder . PHP_EOL;
                } catch (Exception $e) {
                    file_put_contents('./wangwei.log', $incrementId, FILE_APPEND);
                    exception($e->getMessage());
                }
            }
        }
    }

    /**
     * 获取订单详情
     *
     * @param $siteType
     * @param $incrementId
     *
     * @return string
     * @throws DataNotFoundException
     * @throws DbException
     * @throws ModelNotFoundException
     * @author huangbinbin
     * @date   2021/6/25 15:34
     */
    public function getOrderDetail($siteType, $incrementId)
    {
        $order = $this->order->where(['site' => $siteType, 'increment_id' => $incrementId])->find();
        $orderDetails = $this->orderItem->where('order_id', $order->id)->select();
        $postDataCommon = [
            'currency_code' => $order['order_currency_code'],
            'country'       => $order['country_id'],
            'shipping_type' => $order['shipping_method'],
            'telephone'     => $order['telephone'],
            'email'         => $order['customer_email'],
            'first_name'    => $order['customer_firstname'],
            'last_name'     => $order['customer_lastname'],
            'postcode'      => $order['postcode'],
            'city'          => $order['city'],
            'region_id'     => $order['region_id'],
            'street'        => $order['street'],
            'pay_method'    => $order['payment_method'],
            'cpf'           => $order['taxno'],
        ];
        $skuDetail = [];
        foreach ($orderDetails as $key => $orderDetail) {
            $pdCheck = $orderDetail['pdcheck'] == 'on' ? 'on' : '';
            $prismCheck = $orderDetail['prismcheck'] == 'on' ? 'on' : '';
            $is_frame_only = 0;
            if ($orderDetail['index_id'] || $orderDetail['coating_id'] || $orderDetail['color_id']) {
                $is_frame_only = 1;
            }
            if (!$orderDetail['prescription_type'] || $orderDetail['prescription_type'] == 'Frame Only') {
                $is_frame_only = 1;
            }

            $skuDetail[$key] = [
                'sku'               => $orderDetail['sku'],
                'qty'               => $orderDetail['qty'],
                'prescription_type' => $orderDetail['prescription_type'] ?: 'Frame Only',
                'is_frame_only'     => $is_frame_only,
                'od_sph'            => $orderDetail['od_sph'],
                'os_sph'            => $orderDetail['os_sph'],
                'od_cyl'            => $orderDetail['od_cyl'],
                'os_cyl'            => $orderDetail['os_cyl'],
                'od_axis'           => $orderDetail['od_axis'],
                'os_axis'           => $orderDetail['os_axis'],
                'od_add'            => $orderDetail['od_add'],
                'os_add'            => $orderDetail['os_add'],
                'pd'                => $orderDetail['pd'],
                'pdcheck'           => $pdCheck,
                'pd_r'              => $orderDetail['pd_r'],
                'pd_l'              => $orderDetail['pd_l'],
                'prismcheck'        => $prismCheck,
                'od_pv'             => $orderDetail['od_pv'],
                'os_pv'             => $orderDetail['os_pv'],
                'od_bd'             => $orderDetail['od_bd'],
                'os_bd'             => $orderDetail['os_bd'],
                'od_pv_r'           => $orderDetail['od_pv_r'],
                'os_pv_r'           => $orderDetail['os_pv_r'],
                'od_bd_r'           => $orderDetail['od_bd_r'],
                'os_bd_r'           => $orderDetail['os_bd_r'],
                'lens_id'           => $orderDetail['index_id'],
                'lens_name'         => $orderDetail['index_name'],
                'lens_type'         => $orderDetail['index_type'],
                'coating_id'        => $orderDetail['coating_id'],
                'coating_name'      => $orderDetail['coating_name'],
                'color_id'          => $orderDetail['color_id'],
                'color_name'        => '',
            ];
        }
        $postData['product'] = $skuDetail;

        return array_merge($postData, $postDataCommon);
    }


    public function create_wave_order()
    {
        $order_number = [
            '100275071',
            '100275074',
            '100275075',
            '130122983',
            '100275076',
            '100275077',
            '100275078',
            '100275079',
            '100275080',
            '100275081',
            '100275082',
            '130122984',
            '100275083',
            '100275084',
            '100275085',
            '130122985',
            '130122986',
            '130122987',
            '100275086',
            '130122988',
            '130122989',
            '130122990',
            '130122991',
            '130122992',
            '100275087',
            '130122993',
            '130122994',
            '100275088',
            '100275089',
            '100275090',
            '100275091',
            '100275092',
            '130122995',
            '130122996',
            '100275093',
            '100275094',
            '100275095',
            '130122997',
            '130122998',
            '130122999',
            '100275096',
            '130123000',
            '130123001',
            '130123002',
            '130123003',
            '130123004',
            '100275097',
            '130123005',
            '100275099',
            '100275100',
            '100275101',
            '100275102',
            '130123006',
            '130123007',
            '100275103',
            '130123008',
            '130123009',
            '100275104',
            '130123010',
            '100275105',
            '130123011',
            '100275106',
            '100275107',
            '130123012',
            '130123013',
            '130123014',
            '130123015',
            '100275108',
            '100275109',
            '130123016',
            '130123017',
            '130123018',
            '130123019',
            '130123020',
            '130123021',
            '130123022',
            '130123023',
            '130123024',
            '100275110',
            '130123025',
            '130123026',
            '130123027',
            '130123028',
            '130123029',
            '130123030',
            '130123031',
            '130123032',
            '130123033',
            '130123034',
            '130123035',
            '300052789',
            '130123036',
            '130123037',
            '130123038',
            '130123039',
            '130123040',
            '130123041',
            '130123042',
            '130123043',
            '130123044',
            '100275112',
            '100275113',
            '100275114',
            '100275115',
            '100275116',
            '130123045',
            '130123046',
            '130123047',
            '130123048',
            '130123049',
            '130123050',
            '130123051',
            '130123052',
            '100275117',
            '130123053',
            '130123054',
            '130123055',
            '130123056',
            '130123057',
            '130123058',
            '130123059',
            '100275118',
            '130123060',
            '300052790',
            '100275119',
            '100275120',
            '100275121',
            '100275122',
            '100275123',
            '100275124',
            '100275125',
            '100275126',
            '100275127',
            '100275128',
            '100275129',
            '100275130',
            '100275131',
            '100275133',
            '100275134',
            '100275135',
            '130123061',
            '130123062',
            '100275136',
            '130123063',
            '130123064',
            '100275137',
            '100275138',
            '100275139',
            '100275140',
            '130123065',
            '100275141',
            '100275142',
            '100275143',
            '130123066',
            '100275144',
            '130123067',
            '100275145',
            '100275146',
            '130123068',
            '130123069',
            '130123070',
            '100275147',
            '100275148',
            '100275149',
            '100275150',
            '130123071',
            '130123072',
            '100275151',
            '130123073',
            '100275152',
            '130123074',
            '100275153',
            '130123075',
            '100275154',
            '130123076',
            '130123077',
            '130123078',
            '130123079',
            '130123080',
            '130123081',
            '130123082',
            '100275155',
            '130123083',
            '100275156',
            '130123084',
            '130123085',
            '130123086',
            '130123087',
            '100275157',
            '130123088',
            '130123089',
            '130123090',
            '130123091',
            '130123092',
            '130123093',
            '100275158',
            '130123094',
            '130123095',
            '130123096',
            '130123097',
            '100275159',
            '130123098',
            '100275160',
            '130123099',
            '100275162',
            '130123100',
            '130123101',
            '130123102',
            '130123103',
            '130123104',
            '100275163',
            '130123105',
            '130123106',
            '130123107',
            '130123108',
            '130123109',
            '130123110',
            '100275164',
            '130123111',
            '100275165',
            '100275166',
            '130123112',
            '100275167',
            '130123113',
            '100275168',
            '130123114',
            '100275169',
            '100275170',
            '100275171',
            '100275172',
            '100275173',
            '130123115',
            '100275174',
            '130123116',
            '130123117',
            '100275175',
            '100275176',
            '100275177',
            '100275178',
            '100275179',
            '100275180',
            '100275181',
            '130123118',
            '100275182',
            '100275183',
            '130123119',
            '130123120',
            '100275184',
            '130123121',
            '100275185',
            '130123122',
            '130123123',
            '130123124',
            '130123125',
            '130123126',
            '130123127',
            '130123128',
            '130123129',
            '130123130',
            '130123131',
            '100275186',
            '100275187',
            '100275188',
            '100275189',
            '100275190',
            '100275191',
            '100275192',
            '100275193',
            '100275194',
            '130123132',
            '130123133',
            '130123134',
            '100275195',
            '100275196',
            '130123135',
            '100275197',
            '130123136',
            '100275198',
            '130123137',
            '130123138',
            '130123139',
            '100275199',
            '130123140',
            '100275200',
            '100275201',
            '130123141',
            '130123142',
            '130123143',
            '130123144',
            '130123145',
            '130123146',
            '130123147',
            '130123148',
            '100275202',
            '100275203',
            '100275204',
            '100275205',
            '130123149',
            '100275206',
            '100275207',
            '100275208',
            '100275209',
            '100275210',
            '100275211',
            '100275212',
            '300052791',
            '100275213',
            '300052792',
            '300052793',
            '300052794',
            '300052795',
            '300052796',
            '300052797',
            '300052798',
            '130123150',
            '300052799',
            '300052800',
            '100275214',
            '130123151',
            '100275215',
            '100275216',
            '100275217',
            '100275218',
            '100275219',
            '100275220',
            '100275221',
            '100275222',
            '100275223',
            '100275224',
            '130123152',
            '130123153',
            '100275225',
            '100275226',
            '130123154',
            '100275227',
            '100275228',
            '100275229',
            '100275230',
            '130123155',
            '100275231',
            '130123156',
            '100275232',
            '100275233',
            '130123157',
            '130123158',
            '130123159',
            '100275234',
            '100275235',
            '100275236',
            '100275237',
            '100275238',
            '100275239',
            '100275240',
            '100275241',
            '130123160',
            '130123161',
            '100275242',
            '130123162',
            '100275243',
            '130123163',
            '130123164',
            '130123165',
            '130123166',
            '130123167',
            '100275244',
            '130123168',
            '100275245',
            '100275246',
            '100275247',
            '100275248',
            '100275249',
            '100275250',
            '130123169',
            '130123172',
            '130123173',
            '100275251',
            '100275252',
            '100275253',
            '130123174',
            '100275254',
            '130123175',
            '130123176',
            '100275255',
            '130123177',
            '100275256',
            '100275257',
            '100275258',
            '130123178',
            '100275259',
            '100275260',
            '100275261',
            '100275262',
            '130123179',
            '100275263',
            '100275264',
            '100275265',
            '100275266',
            '100275267',
            '100275268',
            '100275269',
            '100275270',
            '100275271',
            '100275272',
            '100275273',
            '100275274',
            '100275275',
            '130123180',
            '100275276',
            '100275277',
            '100275278',
            '130123181',
            '100275279',
            '130123182',
            '130123183',
            '130123184',
            '130123185',
            '130123186',
            '100275280',
            '100275281',
            '100275282',
            '100275283',
            '100275284',
            '130123187',
            '130123188',
            '100275285',
            '100275286',
            '100275287',
            '100275288',
            '100275289',
            '100275290',
            '130123189',
            '130123190',
            '100275291',
            '100275292',
            '130123191',
            '130123192',
            '100275293',
            '100275294',
            '100275295',
            '100275296',
            '100275297',
            '100275298',
            '100275299',
            '100275300',
            '100275301',
            '100275302',
            '100275303',
            '100275304',
            '100275305',
            '100275306',
            '100275307',
            '100275308',
            '100275309',
            '100275310',
            '100275311',
            '100275312',
            '100275313',
            '100275314',
            '130123194',
            '100275315',
            '100275316',
            '100275317',
            '100275318',
            '130123195',
            '130123196',
            '130123197',
            '100275319',
            '130123198',
            '100275320',
            '100275321',
            '100275322',
            '100275323',
            '100275324',
            '100275325',
            '100275326',
            '100275327',
            '100275328',
            '100275329',
            '130123200',
            '300052801',
            '130123201',
            '100275330',
            '300052802',
            '300052803',
            '100275331',
            '100275332',
            '100275333',
            '300052804',
            '300052805',
            '300052806',
            '300052807',
            '100275334',
            '100275335',
            '130123202',
            '130123203',
            '130123204',
            '130123205',
            '130123206',
            '130123207',
            '130123208',
            '100275336',
            '130123209',
            '100275337',
            '100275338',
            '130123210',
            '130123211',
            '100275339',
            '130123212',
            '100275340',
            '100275341',
            '100275342',
            '100275343',
            '100275344',
            '100275345',
            '100275346',
            '100275347',
            '100275348',
            '130123213',
            '100275349',
            '130123214',
            '100275350',
            '130123215',
            '130123216',
            '130123217',
            '130123218',
            '130123219',
            '100275351',
            '100275352',
            '130123220',
            '100275353',
            '100275354',
            '130123221',
            '130123222',
            '100275355',
            '100275356',
            '100275357',
            '100275358',
            '130123223',
            '100275359',
            '130123224',
            '100275360',
            '130123225',
            '130123226',
            '130123227',
            '130123228',
            '130123229',
            '130123230',
            '130123231',
            '100275362',
            '100275363',
            '100275364',
            '130123232',
            '100275365',
            '130123233',
            '130123234',
            '130123235',
            '130123236',
            '130123237',
            '100275366',
            '100275367',
            '100275368',
            '100275369',
            '100275370',
            '100275371',
            '100275372',
            '100275373',
            '100275374',
            '100275375',
            '100275376',
            '130123238',
            '100275378',
            '100275379',
            '100275380',
            '100275382',
            '130123239',
            '130123240',
            '130123241',
            '100275383',
            '100275384',
            '130123242',
            '130123243',
            '130123244',
            '100275385',
            '300052808',
            '130123245',
            '130123246',
            '100275386',
            '100275387',
            '130123247',
            '130123248',
            '100275388',
            '100275389',
            '100275390',
            '130123249',
            '130123250',
            '130123251',
            '130123252',
            '130123253',
            '100275391',
            '130123254',
            '100275392',
            '100275393',
            '100275394',
            '100275395',
            '100275396',
            '100275397',
            '100275398',
            '100275399',
            '100275400',
            '100275401',
            '100275402',
            '100275403',
            '100275404',
            '100275405',
            '100275406',
            '100275407',
            '130123255',
            '130123256',
            '100275408',
            '100275409',
            '100275410',
            '100275411',
            '130123257',
            '130123258',
            '130123259',
            '100275412',
            '100275413',
            '100275414',
            '100275415',
            '100275416',
            '100275417',
            '130123260',
            '100275418',
            '130123261',
            '100275419',
            '100275420',
            '100275421',
            '130123262',
            '100275422',
            '130123263',
            '130123264',
            '100275423',
            '100275424',
            '100275425',
            '130123265',
            '100275426',
            '130123266',
            '130123267',
            '130123268',
            '100275427',
            '100275428',
            '100275430',
            '100275431',
            '100275432',
            '100275433',
            '100275434',
            '100275435',
            '100275436',
            '100275437',
            '100275438',
            '100275439',
            '130123269',
            '130123270',
            '130123271',
            '130123272',
            '130123273',
            '130123274',
            '130123275',
            '130123276',
            '130123277',
            '100275440',
            '100275441',
            '100275442',
            '100275443',
            '100275444',
            '130123278',
            '130123279',
            '130123280',
            '130123281',
            '100275445',
            '100275446',
            '130123282',
            '130123283',
            '100275448',
            '100275449',
            '100275450',
            '100275451',
            '100275452',
            '130123284',
            '100275453',
            '130123285',
            '130123286',
            '130123287',
            '100275454',
            '100275455',
            '100275456',
            '130123288',
            '100275457',
            '100275458',
            '130123289',
            '100275459',
            '100275460',
            '100275461',
            '100275462',
            '130123290',
            '130123291',
            '130123292',
            '130123293',
            '130123294',
            '100275463',
            '130123295',
            '130123296',
            '100275464',
            '100275465',
            '100275466',
            '100275467',
            '100275468',
            '100275469',
            '130123297',
            '130123298',
            '100275470',
            '100275471',
            '100275472',
            '100275473',
            '130123299',
            '100275474',
            '130123300',
            '100275475',
            '100275476',
            '100275477',
            '100275478',
            '130123301',
            '100275480',
            '100275481',
            '130123302',
            '100275482',
            '100275483',
            '100275484',
            '130123304',
            '130123305',
            '100275485',
            '100275486',
            '100275487',
            '130123306',
            '130123307',
            '130123308',
            '100275488',
            '100275489',
            '100275490',
            '130123309',
            '130123310',
            '130123311',
            '130123312',
            '130123313',
            '100275491',
            '130123314',
            '100275492',
            '130123315',
            '100275493',
            '130123316',
            '130123317',
            '100275494',
            '100275495',
            '130123318',
            '130123319',
            '100275496',
            '100275497',
            '100275498',
            '130123320',
            '100275499',
            '100275500',
            '100275501',
            '100275502',
            '100275503',
            '100275504',
            '100275505',
            '130123321',
            '100275506',
            '130123322',
            '130123323',
            '130123324',
            '130123325',
            '100275507',
            '130123326',
            '130123327',
            '130123328',
            '100275508',
            '100275509',
            '130123329',
            '100275510',
            '100275511',
            '130123330',
            '100275512',
            '130123331',
            '130123332',
            '130123333',
            '100275513',
            '100275514',
            '100275515',
            '100275516',
            '100275518',
            '100275519',
            '100275520',
            '100275521',
            '100275523',
            '100275524',
            '130123334',
            '100275525',
            '130123335',
            '130123336',
            '100275526',
            '130123337',
            '130123338',
            '100275527',
            '130123339',
            '100275528',
            '100275529',
            '100275530',
            '100275531',
            '130123340',
            '130123341',
            '100275532',
            '130123342',
            '100275533',
            '100275534',
            '100275535',
            '100275536',
            '100275537',
            '100275538',
            '100275539',
            '100275541',
            '100275542',
            '100275543',
            '100275544',
            '100275545',
            '100275546',
            '100275547',
            '100275548',
            '130123343',
            '100275549',
            '100275550',
            '100275551',
            '100275552',
            '130123344',
            '100275553',
            '130123345',
            '100275554',
            '130123346',
            '130123347',
            '130123348',
            '130123349',
            '130123350',
            '130123351',
            '100275555',
            '100275556',
            '130123352',
            '130123353',
            '130123354',
            '100275557',
            '130123355',
            '130123356',
            '100275558',
            '130123357',
            '100275559',
            '130123358',
            '130123359',
            '130123360',
            '100275560',
            '130123361',
            '100275561',
            '100275562',
            '100275563',
            '130123362',
            '100275564',
            '130123363',
            '130123364',
            '100275565',
            '130123365',
            '100275566',
            '100275567',
            '100275568',
            '100275569',
            '130123366',
            '100275571',
            '100275572',
            '100275573',
            '130123367',
            '100275574',
            '100275575',
            '100275576',
            '100275577',
            '100275578',
            '100275579',
            '100275580',
            '100275581',
            '130123368',
            '100275582',
            '100275583',
            '100275584',
            '100275585',
            '100275586',
            '130123369',
            '100275587',
            '130123370',
            '100275588',
            '100275589',
            '100275590',
            '100275591',
            '100275592',
            '100275593',
            '100275594',
            '100275595',
            '100275596',
            '100275597',
            '130123371',
            '100275598',
            '130123372',
            '130123373',
            '100275599',
            '100275600',
            '100275601',
            '100275602',
            '100275603',
            '130123374',
            '100275604',
            '130123375',
            '130123376',
            '130123377',
            '130123378',
            '130123379',
            '130123380',
            '130123381',
            '100275605',
            '130123382',
            '100275606',
            '100275607',
            '130123383',
            '130123384',
            '130123385',
            '130123386',
            '130123387',
            '130123388',
            '100275609',
            '130123389',
            '130123390',
            '130123391',
            '100275611',
            '130123392',
            '130123393',
            '100275612',
            '100275613',
            '100275614',
            '100275615',
            '100275616',
            '100275617',
            '100275618',
            '130123394',
            '100275619',
            '100275620',
            '100275621',
            '100275622',
            '100275623',
            '100275624',
            '100275625',
            '100275626',
            '100275627',
            '100275628',
            '130123395',
            '100275629',
            '100275630',
            '100275631',
            '100275632',
            '130123396',
            '130123397',
            '100275633',
            '100275634',
            '100275635',
            '100275636',
            '100275637',
            '100275638',
            '100275639',
            '100275640',
            '130123398',
            '130123399',
            '100275641',
            '100275642',
            '100275643',
            '100275644',
            '100275646',
            '100275647',
            '100275648',
            '130123402',
            '100275649',
            '100275650',
            '100275651',
            '130123403',
            '100275652',
            '100275653',
            '100275654',
            '100275655',
            '100275656',
            '100275657',
            '100275658',
            '100275659',
            '130123404',
            '100275660',
            '130123405',
            '130123406',
            '130123407',
            '100275661',
            '130123408',
            '130123409',
            '130123410',
            '130123411',
            '130123412',
            '130123413',
            '130123414',
            '130123415',
            '100275662',
            '130123416',
            '100275663',
            '100275665',
            '100275666',
            '100275667',
            '100275668',
            '100275669',
            '100275670',
            '100275671',
            '100275672',
            '100275674',
            '100275675',
            '100275676',
            '100275677',
            '100275678',
            '100275679',
            '100275680',
            '100275681',
            '100275682',
            '100275683',
            '100275684',
            '130123417',
            '100275685',
            '130123418',
            '100275686',
            '100275687',
            '100275689',
            '100275690',
            '100275691',
            '130123420',
            '130123421',
            '100275692',
            '100275693',
            '100275694',
            '130123422',
            '100275695',
            '100275696',
            '130123423',
            '300052811',
            '100275697',
            '130123424',
            '130123425',
            '130123426',
            '100275698',
            '100275699',
            '100275700',
            '130123427',
            '100275701',
            '130123428',
            '300052812',
            '100275702',
            '130123429',
            '100275703',
            '100275704',
            '100275705',
            '130123430',
            '130123431',
            '100275706',
            '100275707',
            '100275708',
            '100275709',
            '130123432',
            '100275710',
            '130123433',
            '130123434',
            '130123435',
            '130123436',
            '100275711',
            '100275712',
            '100275713',
            '130123437',
            '100275714',
            '100275715',
            '100275716',
            '130123438',
            '100275717',
            '130123439',
            '130123440',
            '100275718',
            '100275719',
            '130123441',
            '130123442',
            '100275721',
            '130123443',
            '130123444',
            '130123445',
            '130123446',
            '130123447',
            '130123448',
            '130123449',
            '130123450',
            '130123451',
            '130123452',
            '130123453',
            '130123454',
            '130123455',
            '130123456',
            '130123457',
            '130123458',
            '130123459',
            '130123460',
            '130123461',
            '130123462',
            '130123463',
            '100275722',
            '130123464',
            '130123465',
            '130123466',
            '100275724',
            '130123467',
            '130123468',
            '130123469',
            '130123470',
            '130123471',
            '130123473',
            '100275726',
            '300052813',
            '130123474',
            '300052814',
            '300052815',
            '130123475',
            '300052816',
            '130123476',
            '300052817',
            '100275727',
            '100275728',
            '100275729',
            '300052818',
            '100275730',
            '300052819',
            '100275731',
            '100275732',
            '130123479',
            '100275733',
            '100275734',
            '100275735',
            '100275736',
            '100275737',
            '130123480',
            '100275738',
            '100275739',
            '100275740',
            '100275741',
            '100275742',
            '100275743',
            '100275745',
            '100275746',
            '100275747',
            '100275748',
            '100275749',
            '100275750',
            '100275751',
            '130123481',
            '100275752',
            '130123482',
            '100275753',
            '100275754',
            '100275755',
            '100275756',
            '100275757',
            '100275758',
            '100275759',
            '100275761',
            '130123483',
            '100275763',
            '300052820',
            '100275764',
            '130123484',
            '300052821',
            '300052822',
            '130123485',
            '100275765',
            '130123486',
            '130123487',
            '130123488',
            '130123489',
            '130123490',
            '130123491',
            '130123492',
            '130123493',
            '130123494',
            '130123495',
            '130123496',
            '130123497',
            '130123498',
            '130123499',
            '130123500',
            '130123501',
            '130123502',
            '130123503',
            '130123504',
            '130123505',
            '130123506',
            '130123507',
            '100275767',
            '100275768',
            '130123508',
            '100275769',
            '130123509',
            '130123510',
            '130123511',
            '130123512',
            '130123513',
            '100275771',
            '130123515',
            '130123516',
            '100275772',
            '100275773',
            '100275774',
            '100275775',
            '130123517',
            '100275776',
            '100275777',
            '130123518',
            '100275778',
            '130123519',
            '130123520',
            '100275779',
            '130123521',
            '130123522',
            '130123523',
            '100275780',
            '130123524',
            '100275781',
            '130123525',
            '130123526',
            '100275782',
            '300052823',
            '100275783',
            '130123527',
            '100275784',
            '130123528',
            '130123529',
            '100275785',
            '130123530',
            '100275786',
            '130123531',
            '100275788',
            '130123532',
            '100275789',
            '130123533',
            '130123534',
            '100275790',
            '100275792',
            '100275793',
            '100275795',
            '100275796',
            '130123535',
            '100275797',
            '100275798',
            '100275799',
            '100275800',
            '100275801',
            '100275803',
            '100275804',
            '100275805',
            '130123536',
            '130123537',
            '130123538',
            '300052824',
            '130123539',
            '130123540',
            '130123541',
            '100275806',
            '130123542',
            '130123543',
            '100275807',
            '100275808',
            '100275809',
            '100275810',
            '100275811',
            '100275812',
            '100275813',
            '100275814',
            '100275815',
            '100275817',
            '100275818',
            '100275819',
            '100275820',
            '100275821',
            '100275822',
            '100275823',
            '100275824',
            '100275826',
            '100275827',
            '100275828',
            '100275829',
            '100275830',
            '100275831',
            '100275832',
            '100275833',
            '100275834',
            '100275835',
            '100275836',
            '130123545',
            '130123546',
            '130123547',
            '100275837',
            '100275838',
            '100275839',
            '130123548',
            '130123549',
            '100275840',
            '130123550',
            '100275841',
            '100275842',
            '130123551',
            '130123552',
            '100275843',
            '100275844',
            '100275845',
            '100275846',
            '100275847',
            '100275848',
            '100275849',
            '100275850',
            '130123554',
            '100275851',
            '100275852',
            '100275853',
            '100275854',
            '130123555',
            '130123556',
            '130123557',
            '130123558',
            '130123559',
            '130123560',
            '130123561',
            '130123562',
            '130123563',
            '130123564',
            '130123565',
            '130123566',
            '130123567',
            '130123568',
            '130123569',
            '130123570',
            '130123571',
            '130123572',
            '130123573',
            '130123574',
            '100275856',
            '130123575',
            '100275857',
            '100275858',
            '100275859',
            '100275860',
            '100275861',
            '300052825',
            '300052826',
            '130123577',
            '130123578',
            '100275862',
            '100275863',
            '100275864',
            '100275865',
            '130123579',
            '100275866',
            '100275867',
            '130123580',
            '100275868',
            '130123581',
            '100275869',
            '100275870',
            '100275871',
            '130123582',
            '100275872',
            '130123583',
            '130123584',
            '100275873',
            '100275874',
            '130123585',
            '100275875',
            '100275877',
            '100275878',
            '100275879',
            '130123586',
            '100275880',
            '300052827',
            '130123587',
            '100275881',
            '130123589',
            '100275882',
            '100275883',
            '100275884',
            '100275886',
            '130123590',
            '130123591',
            '130123592',
            '130123593',
            '130123594',
            '130123595',
            '100275888',
            '100275890',
            '100275892',
            '100275894',
            '100275895',
            '100275896',
            '100275897',
            '100275898',
            '100275899',
            '100275900',
            '100275901',
            '130123596',
            '100275902',
            '130123597',
            '130123598',
            '130123599',
            '130123600',
            '100275903',
            '100275904',
            '130123601',
            '100275906',
            '130123602',
            '130123603',
            '130123604',
            '130123605',
            '100275908',
            '130123606',
            '130123607',
            '130123608',
            '100275909',
            '100275910',
            '100275911',
            '100275912',
            '100275913',
            '100275914',
            '100275915',
            '100275916',
            '130123610',
            '130123611',
            '100275918',
            '100275919',
            '130123612',
            '130123613',
            '130123614',
            '130123615',
            '130123616',
            '130123617',
            '130123618',
            '100275921',
            '130123619',
            '130123620',
            '130123621',
            '130123622',
            '130123623',
            '130123624',
            '130123625',
            '100275923',
            '130123626',
            '130123627',
            '100275924',
            '130123628',
            '130123629',
            '100275925',
            '100275926',
            '100275927',
            '100275928',
            '100275929',
            '100275930',
            '100275931',
            '130123631',
            '130123632',
            '130123633',
            '100275932',
            '130123634',
            '130123635',
            '100275933',
            '100275934',
            '130123636',
            '130123637',
            '130123638',
            '100275935',
            '100275936',
            '100275937',
            '100275938',
            '100275939',
            '130123639',
            '130123640',
            '100275940',
            '100275941',
            '100275942',
            '100275943',
            '100275944',
            '100275945',
            '100275946',
            '130123641',
            '100275947',
            '300052828',
            '300052829',
            '130123642',
            '100275948',
            '130123643',
            '300052830',
            '100275949',
            '100275950',
            '100275951',
            '100275952',
            '100275953',
            '100275955',
            '100275956',
            '100275957',
            '100275958',
            '100275959',
            '100275960',
            '100275961',
            '100275962',
            '100275963',
            '100275964',
            '100275965',
            '100275966',
            '100275967',
            '100275968',
            '100275969',
            '100275970',
            '100275971',
            '100275972',
            '300052831',
            '130123645',
            '300052832',
            '100275973',
            '100275974',
            '100275975',
            '100275976',
            '300052833',
            '300052834',
            '300052835',
            '130123647',
            '100275977',
            '100275978',
            '300052836',
            '130123648',
            '100275979',
            '300052837',
            '130123649',
            '100275980',
            '100275981',
            '130123650',
            '130123651',
            '300052838',
            '100275982',
            '130123652',
            '130123653',
            '100275983',
            '100275984',
            '130123654',
            '100275985',
            '130123656',
            '100275986',
            '100275987',
            '100275988',
            '100275989',
            '100275990',
            '100275991',
            '100275992',
            '100275993',
            '100275994',
            '100275995',
            '100275996',
            '100275997',
            '100275999',
            '100276000',
            '100276002',
            '100276003',
            '100276004',
            '100276006',
            '100276007',
            '100276008',
            '100276009',
            '100276010',
            '100276011',
            '100276012',
            '100276013',
            '100276014',
            '100276015',
            '100276018',
            '100276019',
            '100276020',
            '100276021',
            '100276022',
            '100276023',
            '100276024',
            '100276025',
            '130123658',
            '130123659',
            '130123660',
            '100276026',
            '100276027',
            '100276028',
            '100276029',
            '100276030',
            '100276031',
            '100276032',
            '130123661',
            '130123662',
            '130123663',
            '130123664',
            '130123665',
            '130123666',
            '130123667',
            '130123669',
            '130123670',
            '130123671',
            '130123672',
            '130123673',
            '130123674',
            '130123675',
            '130123676',
            '100276034',
            '100276037',
            '100276038',
            '300052839',
            '100276039',
            '100276040',
            '100276041',
            '130123678',
            '130123679',
            '130123680',
            '130123681',
            '130123682',
            '130123683',
            '100276043',
            '100276044',
            '130123684',
            '100276045',
            '130123685',
            '100276046',
            '130123686',
            '130123687',
            '100276047',
            '130123688',
            '130123689',
            '130123690',
            '130123691',
            '100276048',
            '130123692',
            '100276049',
            '130123693',
            '100276050',
            '130123694',
            '100276051',
            '100276052',
            '130123695',
            '100276053',
            '130123696',
            '130123697',
            '130123698',
            '130123699',
            '130123700',
            '100276055',
            '130123701',
            '130123702',
            '130123703',
            '130123704',
            '130123705',
            '100276057',
            '130123706',
            '130123707',
            '130123708',
            '130123709',
            '130123710',
            '130123711',
            '130123712',
            '130123713',
            '130123714',
            '100276059',
            '130123715',
            '130123716',
            '100276060',
            '130123717',
            '130123718',
            '100276061',
            '130123719',
            '130123720',
            '130123721',
            '130123722',
            '100276062',
            '100276063',
            '100276064',
            '100276065',
            '100276066',
            '130123723',
            '130123724',
            '300052840',
            '130123725',
            '100276067',
            '100276068',
            '100276069',
            '130123726',
            '130123727',
            '100276070',
            '130123728',
            '130123729',
            '130123730',
            '100276071',
            '100276072',
            '130123731',
            '130123732',
            '130123733',
            '100276073',
            '100276074',
            '100276075',
            '130123734',
            '130123735',
            '130123736',
            '100276076',
            '100276077',
            '100276078',
            '100276079',
            '100276080',
            '100276081',
            '100276083',
            '100276084',
            '100276085',
            '100276086',
            '130123738',
            '130123739',
            '130123740',
            '130123741',
            '130123742',
            '130123743',
            '130123744',
            '130123745',
            '100276087',
            '130123746',
            '130123747',
            '130123748',
            '130123749',
            '130123750',
            '100276089',
            '100276090',
            '100276091',
            '100276093',
            '100276094',
            '100276095',
            '100276096',
            '100276097',
            '100276098',
            '100276099',
            '100276100',
            '100276101',
            '100276102',
            '100276103',
            '300052841',
            '130123751',
            '130123752',
            '100276104',
            '130123753',
            '100276105',
            '130123754',
            '130123755',
            '100276106',
            '130123756',
            '100276107',
            '100276109',
            '100276110',
            '100276111',
            '130123757',
            '130123758',
            '130123759',
            '130123760',
            '100276112',
            '100276113',
            '100276114',
            '100276115',
            '100276116',
            '100276117',
            '100276118',
            '100276119',
            '100276120',
            '100276121',
            '130123762',
            '100276122',
            '100276123',
            '100276124',
            '100276125',
            '130123763',
            '100276126',
            '130123764',
            '100276127',
            '100276128',
            '130123765',
            '100276129',
            '100276131',
            '100276132',
            '130123766',
            '130123767',
            '130123768',
            '100276133',
            '100276134',
            '100276136',
            '100276138',
            '100276139',
            '100276141',
            '130123769',
            '130123770',
            '130123771',
            '130123772',
            '100276142',
            '130123773',
            '130123774',
            '130123775',
            '100276143',
            '100276144',
            '100276145',
            '100276146',
            '100276147',
            '100276148',
            '130123777',
            '100276149',
            '100276150',
            '100276151',
            '100276152',
            '130123778',
            '130123779',
            '100276153',
            '130123781',
            '130123782',
            '100276154',
            '130123783',
            '130123784',
            '130123785',
            '100276155',
            '100276156',
            '130123786',
            '100276157',
            '100276158',
            '130123787',
            '100276159',
            '100276160',
            '130123788',
            '100276162',
            '100276163',
        ];
        /**
         *
         * 生成规则
         * 1）按业务模式：品牌独立站、第三方平台店铺
         * 2）按时间段
         * 第一波次：00:00-2:59:59
         * 第二波次：3：00-5:59:59
         * 第三波次：6:00-8:59:59
         * 第四波次：9:00-11:59:59
         * 第五波次：12:00-14:59:59
         * 第六波次：15:00-17:59:59
         * 第七波次：18:00-20:59:59
         * 第八波次：21:00-23:59:59
         *
         */
        $where['a.increment_id'] = ['in', $order_number];

        $list = $this->order->where($where)->alias('a')
            ->field('b.id,b.sku,a.created_at,a.updated_at,entity_id,a.site,a.is_custom_lens,a.stock_id')
            ->join(['fa_order_item_process' => 'b'], 'a.entity_id=b.magento_order_id and a.site=b.site')
            ->order('id desc')
            ->select();
        $list = collection($list)->toArray();
        //第三方站点id
        $third_site = [13, 14];
        $this->orderitemprocess = new NewOrderItemProcess();
        $itemPlatform = new ItemPlatformSku();
        foreach ($list as $k => $v) {


            $stockId = 1; //郑州仓
            $id = 1396;

            //转换平台SKU
            $sku = $itemPlatform->getTrueSku($v['sku'], $v['site']);
            //根据sku查询库位排序
            $stockSku = new StockSku();
            $where = [];
            $where['c.type'] = 2;//默认拣货区
            $where['b.status'] = 1;//启用状态
            $where['a.is_del'] = 1;//正常状态
            $where['b.stock_id'] = $stockId;//查询对应仓库
            $location_data = $stockSku
                ->alias('a')
                ->where($where)
                ->where(['a.sku' => $sku])
                ->field('b.coding,b.picking_sort')
                ->join(['fa_store_house' => 'b'], 'a.store_id=b.id')
                ->join(['fa_warehouse_area' => 'c'], 'b.area_id=c.id')
                ->find();
            $this->orderitemprocess->where(['id' => $v['id']])->update(['wave_order_id' => $id, 'location_code' => $location_data['coding'], 'picking_sort' => $location_data['picking_sort']]);
        }
        echo "ok";
    }
}




